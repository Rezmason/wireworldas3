#!/bin/bash

#Here's the address to mxmlc. Modify it if yours isn't here.
mxmlc="/SDKs/flex/flex_sdk_4.0.0.14159/bin/mxmlc"

#find the folder "wireworld" in this executable's parent directory
abspath="$(cd "${0%/*}" 2>/dev/null; echo "$PWD"/"${0##*/}")"
mydir=`dirname "$abspath"`

pushd $mydir/../

apparat="../../../apparat_old/apparat.jar"
scala="/SDKs/scala-2.8.0.RC3/bin/scala"
apparatSWC="../../../apparat/apparat.swc"
flexSWC="/SDKs/flex/4.0.0.4904/frameworks/libs"
greensockSWC="./lib/greensock.swc"

function wwBuild {
	
	if [ $# -lt 3 ]
	then
	  echo "Too few arguments."
	  exit 1
	fi
	
	debug=false
	optimize=false
	if [ $# -ge 6 ] && $6; then
		debug=true
	else
		debug=false
		optimize=true
	fi
	
	echo "$1 $2, $3, debug = $debug"
	
	brainDef="-define+=BRAIN::"
	brainDefs=""
	for word in CONVOLUTION_FILTER LINKED_LIST PIXEL_BENDER STANDARD TREE TREE_TDSI TDSI VECTOR HAXE STUPID BYTES AZOTH ALL
	do
		if test $word == $1; then
			value=true
		else
			value=false
		fi
		brainDefs="$brainDefs ${brainDef}${word},${value}"
	done
	
	brainDefs="$brainDefs ${brainDef}MODEL_TYPE,\"$1\""
	
	viewDef="-define+=VIEW::"
	viewDefs=""
	for word in OLD NEW
	do
		if test $word == $2; then
			value=true
		else
			value=false
		fi
		viewDefs="$viewDefs ${viewDef}${word},${value}"
	done
	
	viewDefs="$viewDefs ${viewDef}VIEW_TYPE,\"$2\""
	
	"$mxmlc" src/Wireworld.as $brainDefs $viewDefs -sp src -o deploy/bin/$3.swf -l $apparatSWC $flexSWC $greensockSWC -static-link-runtime-shared-libraries=true -optimize=$optimize -debug=$debug && 
	
	if [ $# -ge 4 ] && $4; then
		"$scala" -cp "$apparat" apparat.tools.tdsi.TurboDieselSportInjection -i deploy/bin/$3.swf
	fi
	
	if [ $# -ge 5 ] && $5; then
		open deploy/bin/$3.swf -a Flash\ Player.app
	fi
	
	echo
}

wwBuild STANDARD OLD wireworld true
wwBuild STUPID OLD wwfirst true
wwBuild BYTES OLD wwbytes true
wwBuild CONVOLUTION_FILTER OLD wwcf true
wwBuild PIXEL_BENDER OLD wwpb true
wwBuild VECTOR OLD wwvec true
wwBuild LINKED_LIST OLD wwll true
wwBuild TDSI OLD wwtdsi true
wwBuild AZOTH OLD wwazoth true
#wwBuild HAXE OLD wwhx true
 
zip -r ../archive/wireworld_`date "+%m_%d_%Y"` . -u -x '*.svn*' '*.DS_Store'
zip -r ../wireworld_deploy deploy -u -x '*.svn*' '*.DS_Store'

popd